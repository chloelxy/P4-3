import pandas as pd
import numpy as np
import os

# --------------------------
# Function to clean & add indicators
# --------------------------
def process_stock(file_path, sma_window=20):
    df = pd.read_csv(file_path)
    
    # Convert Date column to datetime
    if 'Date' in df.columns:
        df['Date'] = pd.to_datetime(df['Date'], errors='coerce')
        df = df.dropna(subset=['Date'])
        df = df.set_index('Date').sort_index()
    
    # Fill missing numeric values
    num_cols = df.select_dtypes(include='number').columns
    df[num_cols] = df[num_cols].ffill().bfill()
    
    # Indicators
    df[f"SMA_{sma_window}"] = df['Close'].rolling(window=sma_window).mean()
    df['Daily_Return'] = df['Close'].pct_change()
    
    # Price streaks
    sign = df['Daily_Return'].apply(lambda x: 1 if x>0 else (-1 if x<0 else 0))
    grp = (sign != sign.shift()).cumsum()
    df['Price_Streak'] = sign * (sign.groupby(grp).cumcount() + 1)
    
    # Save processed file
    processed_file = file_path.replace("_raw.csv", "_processed.csv")
    df.to_csv(processed_file)
    print(f"Processed {processed_file}")

# --------------------------
# Process all raw CSVs in a folder
# --------------------------
raw_folder = r"C:\Users\Novaa\Downloads"  # folder where *_raw.csv files are saved

# Loop through all raw CSV files
for filename in os.listdir(raw_folder):
    if filename.endswith("_raw.csv"):
        file_path = os.path.join(raw_folder, filename)
        process_stock(file_path)
